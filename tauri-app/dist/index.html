<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Pipeline</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.2.1/dist/chartjs-chart-financial.min.js"></script>
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent: #38bdf8;
            --accent-hover: #0ea5e9;
            --success: #22c55e;
            --error: #ef4444;
            --border: #475569;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 30px;
        }

        h1 {
            font-size: 1.8rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        h1::before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--accent);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .stats {
            display: flex;
            gap: 20px;
        }

        .stat {
            text-align: center;
            padding: 10px 20px;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
        }

        .card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
        }

        .card-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .fetch-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        input, select {
            padding: 12px 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 1rem;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--accent);
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            background: var(--accent);
            color: var(--bg-primary);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        button:hover {
            background: var(--accent-hover);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .symbol-list {
            list-style: none;
            max-height: 400px;
            overflow-y: auto;
        }

        .symbol-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.2s;
        }

        .symbol-item:hover {
            background: var(--bg-card);
        }

        .symbol-item:last-child {
            border-bottom: none;
        }

        .symbol-ticker {
            font-weight: 600;
            font-family: 'Monaco', 'Menlo', monospace;
        }

        .symbol-price {
            color: var(--success);
            font-weight: 600;
        }

        .log-container {
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 15px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.85rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid var(--border);
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-success { color: var(--success); }
        .log-error { color: var(--error); }
        .log-info { color: var(--accent); }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }

        .tab.active {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--bg-primary);
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .quick-action {
            padding: 15px;
            text-align: center;
            font-size: 0.9rem;
        }

        .chart-container {
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            height: 300px;
        }

        .chart-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .chart-controls select {
            min-width: 150px;
        }

        .indicator-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .indicator-values {
            max-height: 250px;
            overflow-y: auto;
        }

        @media (max-width: 768px) {
            .indicator-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Financial Pipeline</h1>
            <div class="stats">
                <div class="stat">
                    <div class="stat-value" id="symbol-count">0</div>
                    <div class="stat-label">Symbols</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="record-count">0</div>
                    <div class="stat-label">Records</div>
                </div>
            </div>
        </header>

        <div class="grid">
            <div class="sidebar">
                <div class="card">
                    <h3 class="card-title">Fetch Data</h3>
                    <form class="fetch-form" id="fetch-form">
                        <div class="input-group">
                            <label for="symbols">Symbols</label>
                            <input type="text" id="symbols" placeholder="AAPL, MSFT, GOOGL" />
                        </div>
                        <div class="input-group">
                            <label for="period">Period</label>
                            <select id="period">
                                <option value="1mo">1 Month</option>
                                <option value="3mo">3 Months</option>
                                <option value="6mo">6 Months</option>
                                <option value="1y" selected>1 Year</option>
                                <option value="2y">2 Years</option>
                                <option value="5y">5 Years</option>
                                <option value="max">Max</option>
                            </select>
                        </div>
                        <button type="submit" id="fetch-btn">Fetch Prices</button>
                    </form>

                    <div class="quick-actions">
                        <button class="quick-action btn-secondary" onclick="fetchQuick('AAPL,MSFT,GOOGL')">
                            Tech Giants
                        </button>
                        <button class="quick-action btn-secondary" onclick="fetchQuick('SPY,QQQ,DIA')">
                            ETFs
                        </button>
                        <button class="quick-action btn-secondary" onclick="fetchFred('DFF,UNRATE')">
                            FRED Macro
                        </button>
                        <button class="quick-action btn-secondary" onclick="refreshList()">
                            Refresh
                        </button>
                    </div>
                </div>
            </div>

            <div class="main">
                <div class="card">
                    <div class="tabs">
                        <button class="tab active" onclick="switchTab('stocks')">Stocks</button>
                        <button class="tab" onclick="switchTab('indicators')">Indicators</button>
                        <button class="tab" onclick="switchTab('macro')">Macro Data</button>
                        <button class="tab" onclick="switchTab('log')">Log</button>
                    </div>

                    <div id="stocks-tab">
                        <ul class="symbol-list" id="symbol-list">
                            <li class="empty-state">No data loaded. Fetch some symbols to get started.</li>
                        </ul>
                    </div>

                    <div id="indicators-tab" style="display: none;">
                        <div class="chart-controls">
                            <input type="text" id="indicator-symbol" placeholder="Symbol (e.g., AAPL)" style="width: 150px;" />
                            <select id="indicator-select">
                                <option value="">-- Select Chart --</option>
                                <option value="CANDLESTICK">Candlestick (OHLC)</option>
                                <option value="PRICE">Price (Close)</option>
                                <option value="RSI_14">RSI (14)</option>
                                <option value="SMA_20">SMA (20)</option>
                                <option value="SMA_50">SMA (50)</option>
                                <option value="EMA_12">EMA (12)</option>
                                <option value="EMA_26">EMA (26)</option>
                                <option value="BB_UPPER_20">Bollinger Upper</option>
                                <option value="BB_MIDDLE_20">Bollinger Middle</option>
                                <option value="BB_LOWER_20">Bollinger Lower</option>
                                <option value="ATR_14">ATR (14)</option>
                                <option value="STOCH_K_14">Stochastic %K</option>
                                <option value="STOCH_D_3">Stochastic %D</option>
                                <option value="OBV">OBV (Volume)</option>
                                <option value="ADX_14">ADX (Trend)</option>
                                <option value="+DI_14">+DI (Bullish)</option>
                                <option value="-DI_14">-DI (Bearish)</option>
                                <option value="MACD_12_26">MACD</option>
                                <option value="MACD_SIGNAL_9">MACD Signal</option>
                                <option value="MACD_HIST">MACD Histogram</option>
                            </select>
                            <button onclick="calculateIndicators()">Calculate</button>
                            <button class="btn-secondary" onclick="showChart()">Show Chart</button>
                        </div>
                        <div class="indicator-grid">
                            <div>
                                <h4 style="color: var(--text-secondary); margin-bottom: 10px;">Latest Values</h4>
                                <ul class="symbol-list indicator-values" id="indicator-list">
                                    <li class="empty-state">Select a symbol and Calculate</li>
                                </ul>
                            </div>
                            <div>
                                <h4 style="color: var(--text-secondary); margin-bottom: 10px;">Chart</h4>
                                <div class="chart-container">
                                    <canvas id="indicator-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="macro-tab" style="display: none;">
                        <ul class="symbol-list" id="macro-list">
                            <li class="empty-state">No macro data loaded.</li>
                        </ul>
                    </div>

                    <div id="log-tab" style="display: none;">
                        <div class="log-container" id="log-container">
                            <div class="log-entry log-info">[INIT] Financial Pipeline ready</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Tauri v2 API
        async function invoke(cmd, args = {}) {
            if (window.__TAURI__ && window.__TAURI__.core && window.__TAURI__.core.invoke) {
                console.log('Tauri invoke:', cmd, args);
                try {
                    const result = await window.__TAURI__.core.invoke(cmd, args);
                    console.log('Tauri result:', result);
                    return result;
                } catch (e) {
                    console.error('Tauri error:', e);
                    throw e;
                }
            } else {
                console.log('Mock invoke (Tauri not available):', cmd, args);
                return mockInvoke(cmd, args);
            }
        }

        // Mock invoke for testing in browser
        async function mockInvoke(cmd, args) {
            if (cmd === 'get_symbols') {
                return [
                    { symbol: 'AAPL', price: 261.05 },
                    { symbol: 'MSFT', price: 470.67 }
                ];
            }
            if (cmd === 'fetch_prices') {
                return { success: true, message: 'Fetched ' + args.symbols };
            }
            return null;
        }

        function log(message, type = 'info') {
            const container = document.getElementById('log-container');
            const entry = document.createElement('div');
            entry.className = 'log-entry log-' + type;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }

        async function refreshList() {
            try {
                log('Refreshing symbol list...', 'info');
                const symbols = await invoke('get_symbols');
                const list = document.getElementById('symbol-list');

                if (symbols && symbols.length > 0) {
                    list.innerHTML = symbols.map(s => `
                        <li class="symbol-item" onclick="showDetails('${s.symbol}')">
                            <span class="symbol-ticker">${s.symbol}</span>
                            <span class="symbol-price">$${s.price.toFixed(2)}</span>
                        </li>
                    `).join('');
                    document.getElementById('symbol-count').textContent = symbols.length;
                    log(`Loaded ${symbols.length} symbols`, 'success');
                } else {
                    list.innerHTML = '<li class="empty-state">No data loaded. Fetch some symbols to get started.</li>';
                }
            } catch (e) {
                log('Error refreshing: ' + e, 'error');
            }
        }

        async function fetchPrices(symbols, period) {
            const statusEl = document.querySelector('.stat-value');
            const origText = statusEl.textContent;
            statusEl.textContent = '...';
            statusEl.style.color = '#f59e0b';

            try {
                log(`Fetching ${symbols} (${period})...`, 'info');
                const result = await invoke('fetch_prices', { symbols, period });
                log(result.message, result.success ? 'success' : 'error');
                alert(result.message);
                await refreshList();
            } catch (e) {
                log('Error fetching: ' + e, 'error');
                alert('Error: ' + e);
            } finally {
                statusEl.style.color = '#38bdf8';
            }
        }

        async function fetchQuick(symbols) {
            const period = document.getElementById('period').value;
            await fetchPrices(symbols, period);
        }

        async function fetchFred(indicators) {
            try {
                log(`Fetching FRED indicators: ${indicators}...`, 'info');
                const result = await invoke('fetch_fred', { indicators });
                log(result.message, result.success ? 'success' : 'error');
                alert(result.message);
            } catch (e) {
                log('Error fetching FRED: ' + e, 'error');
                alert('Error: ' + e);
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');

            document.getElementById('stocks-tab').style.display = tab === 'stocks' ? 'block' : 'none';
            document.getElementById('indicators-tab').style.display = tab === 'indicators' ? 'block' : 'none';
            document.getElementById('macro-tab').style.display = tab === 'macro' ? 'block' : 'none';
            document.getElementById('log-tab').style.display = tab === 'log' ? 'block' : 'none';
        }

        async function calculateIndicators() {
            const symbol = document.getElementById('indicator-symbol').value.trim();
            if (!symbol) {
                alert('Please enter a symbol');
                return;
            }

            try {
                log(`Calculating indicators for ${symbol}...`, 'info');
                const result = await invoke('calculate_indicators', { symbol });
                log(result.message, result.success ? 'success' : 'error');
                alert(result.message);
                if (result.success) {
                    await loadIndicators();
                }
            } catch (e) {
                log('Error calculating: ' + e, 'error');
                alert('Error: ' + e);
            }
        }

        async function loadIndicators() {
            const symbol = document.getElementById('indicator-symbol').value.trim();
            if (!symbol) {
                alert('Please enter a symbol');
                return;
            }

            try {
                log(`Loading indicators for ${symbol}...`, 'info');
                const indicators = await invoke('get_indicators', { symbol });
                const list = document.getElementById('indicator-list');

                if (indicators && indicators.length > 0) {
                    list.innerHTML = indicators.map(ind => `
                        <li class="symbol-item" onclick="chartIndicator('${ind.name}')">
                            <span class="symbol-ticker">${ind.name}</span>
                            <span class="symbol-price">${ind.value.toFixed(2)}</span>
                        </li>
                    `).join('');
                    log(`Loaded ${indicators.length} indicators for ${symbol}`, 'success');
                } else {
                    list.innerHTML = '<li class="empty-state">No indicators calculated. Click Calculate first.</li>';
                }
            } catch (e) {
                log('Error loading indicators: ' + e, 'error');
                alert('Error: ' + e);
            }
        }

        // Chart instance
        let indicatorChart = null;

        async function showChart() {
            const symbol = document.getElementById('indicator-symbol').value.trim();
            const indicatorName = document.getElementById('indicator-select').value;

            if (!symbol) {
                alert('Please enter a symbol');
                return;
            }

            if (!indicatorName) {
                alert('Please select an indicator');
                return;
            }

            await chartIndicator(indicatorName);
        }

        async function chartIndicator(indicatorName) {
            const symbol = document.getElementById('indicator-symbol').value.trim();
            if (!symbol) {
                alert('Please enter a symbol');
                return;
            }

            try {
                log(`Loading chart data for ${symbol} ${indicatorName}...`, 'info');

                // Destroy existing chart
                if (indicatorChart) {
                    indicatorChart.destroy();
                }

                const ctx = document.getElementById('indicator-chart').getContext('2d');

                if (indicatorName === 'CANDLESTICK') {
                    // Candlestick chart
                    const prices = await invoke('get_price_history', { symbol });
                    if (prices.length === 0) {
                        alert('No price data available. Fetch prices first.');
                        return;
                    }

                    const candleData = prices.map(p => ({
                        x: new Date(p.date).getTime(),
                        o: p.open,
                        h: p.high,
                        l: p.low,
                        c: p.close
                    }));

                    indicatorChart = new Chart(ctx, {
                        type: 'candlestick',
                        data: {
                            datasets: [{
                                label: `${symbol} OHLC`,
                                data: candleData,
                                color: {
                                    up: '#22c55e',
                                    down: '#ef4444',
                                    unchanged: '#94a3b8'
                                },
                                borderColor: {
                                    up: '#22c55e',
                                    down: '#ef4444',
                                    unchanged: '#94a3b8'
                                }
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    labels: { color: '#f1f5f9' }
                                }
                            },
                            scales: {
                                x: {
                                    type: 'time',
                                    time: {
                                        unit: 'day',
                                        displayFormats: { day: 'MMM d' }
                                    },
                                    ticks: { color: '#94a3b8', maxTicksLimit: 10 },
                                    grid: { color: '#334155' }
                                },
                                y: {
                                    ticks: { color: '#94a3b8' },
                                    grid: { color: '#334155' }
                                }
                            }
                        }
                    });

                    log(`Candlestick chart loaded for ${symbol}`, 'success');
                } else {
                    // Line chart for price or indicators
                    let data, labels, label, borderColor;

                    if (indicatorName === 'PRICE') {
                        const prices = await invoke('get_price_history', { symbol });
                        labels = prices.map(p => p.date);
                        data = prices.map(p => p.close);
                        label = `${symbol} Close Price`;
                        borderColor = '#38bdf8';
                    } else {
                        const history = await invoke('get_indicator_history', { symbol, indicatorName });
                        labels = history.map(h => h.date);
                        data = history.map(h => h.value);
                        label = `${symbol} ${indicatorName}`;

                        if (indicatorName.startsWith('RSI')) {
                            borderColor = '#f59e0b';
                        } else if (indicatorName.startsWith('SMA')) {
                            borderColor = '#22c55e';
                        } else if (indicatorName.startsWith('EMA')) {
                            borderColor = '#8b5cf6';
                        } else if (indicatorName.startsWith('MACD')) {
                            borderColor = '#ef4444';
                        } else if (indicatorName.startsWith('BB_')) {
                            borderColor = '#ec4899'; // Pink for Bollinger Bands
                        } else if (indicatorName.startsWith('ATR')) {
                            borderColor = '#14b8a6'; // Teal for ATR
                        } else if (indicatorName.startsWith('STOCH')) {
                            borderColor = '#06b6d4'; // Cyan for Stochastic
                        } else if (indicatorName === 'OBV') {
                            borderColor = '#a855f7'; // Purple for OBV
                        } else if (indicatorName.startsWith('ADX') || indicatorName.includes('DI_')) {
                            borderColor = '#f97316'; // Orange for ADX/DI
                        } else {
                            borderColor = '#38bdf8';
                        }
                    }

                    if (data.length === 0) {
                        alert('No data available. Calculate indicators first.');
                        return;
                    }

                    indicatorChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: label,
                                data: data,
                                borderColor: borderColor,
                                backgroundColor: borderColor + '20',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.1,
                                pointRadius: 0,
                                pointHoverRadius: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    labels: { color: '#f1f5f9' }
                                }
                            },
                            scales: {
                                x: {
                                    ticks: { color: '#94a3b8', maxTicksLimit: 10 },
                                    grid: { color: '#334155' }
                                },
                                y: {
                                    ticks: { color: '#94a3b8' },
                                    grid: { color: '#334155' }
                                }
                            },
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            }
                        }
                    });

                    log(`Chart loaded for ${label}`, 'success');
                }
            } catch (e) {
                log('Error loading chart: ' + e, 'error');
                alert('Error: ' + e);
            }
        }

        function showDetails(symbol) {
            log(`Selected ${symbol}`, 'info');
            // TODO: Show price chart
        }

        // Form submission
        document.getElementById('fetch-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const symbols = document.getElementById('symbols').value;
            const period = document.getElementById('period').value;
            if (symbols) {
                await fetchPrices(symbols, period);
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            log('Financial Pipeline UI loaded', 'success');
            refreshList();
        });
    </script>
</body>
</html>
