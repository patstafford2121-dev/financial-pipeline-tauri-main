<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Pipeline</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.2.1/dist/chartjs-chart-financial.min.js"></script>
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent: #38bdf8;
            --accent-hover: #0ea5e9;
            --success: #22c55e;
            --error: #ef4444;
            --border: #475569;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 30px;
        }

        h1 {
            font-size: 1.8rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        h1::before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--accent);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .stats {
            display: flex;
            gap: 20px;
        }

        .stat {
            text-align: center;
            padding: 10px 20px;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
        }

        .card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
        }

        .card-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .fetch-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        input, select {
            padding: 12px 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 1rem;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--accent);
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            background: var(--accent);
            color: var(--bg-primary);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        button:hover {
            background: var(--accent-hover);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .symbol-list {
            list-style: none;
            max-height: 400px;
            overflow-y: auto;
        }

        .symbol-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.2s;
        }

        .symbol-item:hover {
            background: var(--bg-card);
        }

        .symbol-item:last-child {
            border-bottom: none;
        }

        .symbol-ticker {
            font-weight: 600;
            font-family: 'Monaco', 'Menlo', monospace;
        }

        .symbol-price {
            color: var(--success);
            font-weight: 600;
        }

        .log-container {
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 15px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.85rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid var(--border);
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-success { color: var(--success); }
        .log-error { color: var(--error); }
        .log-info { color: var(--accent); }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }

        .tab.active {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--bg-primary);
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .quick-action {
            padding: 15px;
            text-align: center;
            font-size: 0.9rem;
        }

        .chart-container {
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            height: 300px;
        }

        .chart-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .chart-controls select {
            min-width: 150px;
        }

        .indicator-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .indicator-values {
            max-height: 250px;
            overflow-y: auto;
        }

        @media (max-width: 768px) {
            .indicator-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Auto-refresh toggle */
        .auto-refresh-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px 15px;
            background: var(--bg-card);
            border-radius: 8px;
            margin-left: 20px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border);
            transition: 0.3s;
            border-radius: 26px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: var(--text-primary);
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--success);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        .refresh-status {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .refresh-status.active {
            color: var(--success);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Financial Pipeline</h1>
            <div class="stats">
                <div class="stat">
                    <div class="stat-value" id="symbol-count">0</div>
                    <div class="stat-label">Symbols</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="last-refresh">--:--</div>
                    <div class="stat-label">Last Update</div>
                </div>
                <div class="auto-refresh-controls">
                    <label class="toggle-switch">
                        <input type="checkbox" id="auto-refresh-toggle" onchange="toggleAutoRefresh()">
                        <span class="toggle-slider"></span>
                    </label>
                    <select id="refresh-interval" onchange="updateRefreshInterval()" style="padding: 5px 10px;">
                        <option value="60000">1 min</option>
                        <option value="300000" selected>5 min</option>
                        <option value="900000">15 min</option>
                        <option value="1800000">30 min</option>
                    </select>
                    <span id="refresh-status" class="refresh-status">Auto-refresh off</span>
                </div>
            </div>
        </header>

        <div class="grid">
            <div class="sidebar">
                <div class="card">
                    <h3 class="card-title">Fetch Data</h3>
                    <form class="fetch-form" id="fetch-form">
                        <div class="input-group">
                            <label for="symbols">Symbols</label>
                            <input type="text" id="symbols" placeholder="AAPL, MSFT, GOOGL" />
                        </div>
                        <div class="input-group">
                            <label for="period">Period</label>
                            <select id="period">
                                <option value="1mo">1 Month</option>
                                <option value="3mo">3 Months</option>
                                <option value="6mo">6 Months</option>
                                <option value="1y" selected>1 Year</option>
                                <option value="2y">2 Years</option>
                                <option value="5y">5 Years</option>
                                <option value="max">Max</option>
                            </select>
                        </div>
                        <button type="submit" id="fetch-btn">Fetch Prices</button>
                    </form>

                    <div style="margin: 15px 0;">
                        <input type="text" id="search-input" placeholder="Search (e.g., nvidia, apple)" style="width: 100%;" oninput="searchCompany(this.value)" />
                        <div id="search-results" style="margin-top: 5px;"></div>
                    </div>

                    <div class="quick-actions">
                        <button class="quick-action btn-secondary" onclick="fetchQuick('AAPL,MSFT,GOOGL')">
                            Tech Giants
                        </button>
                        <button class="quick-action btn-secondary" onclick="fetchQuick('SPY,QQQ,DIA')">
                            ETFs
                        </button>
                        <button class="quick-action btn-secondary" onclick="fetchFred('DFF,UNRATE')">
                            FRED Macro
                        </button>
                        <button class="quick-action btn-secondary" onclick="refreshList()">
                            Refresh
                        </button>
                    </div>
                </div>
            </div>

            <div class="main">
                <div class="card">
                    <div class="tabs">
                        <button class="tab active" onclick="switchTab('stocks')">Stocks</button>
                        <button class="tab" onclick="switchTab('indicators')">Indicators</button>
                        <button class="tab" onclick="switchTab('alerts')">Alerts</button>
                        <button class="tab" onclick="switchTab('portfolio')">Portfolio</button>
                        <button class="tab" onclick="switchTab('macro')">Macro Data</button>
                        <button class="tab" onclick="switchTab('log')">Log</button>
                    </div>

                    <div id="stocks-tab">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span style="color: var(--text-secondary); font-size: 0.9rem;">Sort by:</span>
                            <select id="sort-select" onchange="refreshList()" style="padding: 8px 12px;">
                                <option value="change-desc">% Change (High to Low)</option>
                                <option value="change-asc">% Change (Low to High)</option>
                                <option value="price-desc">Price (High to Low)</option>
                                <option value="price-asc">Price (Low to High)</option>
                                <option value="symbol-asc">Symbol (A-Z)</option>
                                <option value="symbol-desc">Symbol (Z-A)</option>
                            </select>
                        </div>
                        <ul class="symbol-list" id="symbol-list">
                            <li class="empty-state">No data loaded. Fetch some symbols to get started.</li>
                        </ul>
                    </div>

                    <div id="indicators-tab" style="display: none;">
                        <div class="chart-controls">
                            <input type="text" id="indicator-symbol" placeholder="Symbol (e.g., AAPL)" style="width: 150px;" />
                            <select id="indicator-select">
                                <option value="">-- Select Chart --</option>
                                <option value="CANDLESTICK">Candlestick (OHLC)</option>
                                <option value="PRICE">Price (Close)</option>
                                <option value="RSI_14">RSI (14)</option>
                                <option value="SMA_20">SMA (20)</option>
                                <option value="SMA_50">SMA (50)</option>
                                <option value="EMA_12">EMA (12)</option>
                                <option value="EMA_26">EMA (26)</option>
                                <option value="BB_UPPER_20">Bollinger Upper</option>
                                <option value="BB_MIDDLE_20">Bollinger Middle</option>
                                <option value="BB_LOWER_20">Bollinger Lower</option>
                                <option value="ATR_14">ATR (14)</option>
                                <option value="STOCH_K_14">Stochastic %K</option>
                                <option value="STOCH_D_3">Stochastic %D</option>
                                <option value="OBV">OBV (Volume)</option>
                                <option value="ADX_14">ADX (Trend)</option>
                                <option value="+DI_14">+DI (Bullish)</option>
                                <option value="-DI_14">-DI (Bearish)</option>
                                <option value="MACD_12_26">MACD</option>
                                <option value="MACD_SIGNAL_9">MACD Signal</option>
                                <option value="MACD_HIST">MACD Histogram</option>
                                <option value="GOOGLE_TRENDS">Google Trends</option>
                            </select>
                            <button onclick="calculateIndicators()">Calculate</button>
                            <button class="btn-secondary" onclick="fetchTrends()">Fetch Trends</button>
                            <button class="btn-secondary" onclick="showChart()">Show Chart</button>
                        </div>
                        <div class="indicator-grid">
                            <div>
                                <h4 style="color: var(--text-secondary); margin-bottom: 10px;">Latest Values</h4>
                                <ul class="symbol-list indicator-values" id="indicator-list">
                                    <li class="empty-state">Select a symbol and Calculate</li>
                                </ul>
                            </div>
                            <div>
                                <h4 style="color: var(--text-secondary); margin-bottom: 10px;">Chart</h4>
                                <div class="chart-container">
                                    <canvas id="indicator-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="alerts-tab" style="display: none;">
                        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px;">
                            <div>
                                <h4 style="color: var(--text-secondary); margin-bottom: 15px;">Add Price Alert</h4>
                                <div class="fetch-form">
                                    <div class="input-group">
                                        <label for="alert-symbol">Symbol</label>
                                        <input type="text" id="alert-symbol" placeholder="AAPL" />
                                    </div>
                                    <div class="input-group">
                                        <label for="alert-price">Target Price</label>
                                        <input type="number" id="alert-price" placeholder="150.00" step="0.01" />
                                    </div>
                                    <div class="input-group">
                                        <label for="alert-condition">Condition</label>
                                        <select id="alert-condition">
                                            <option value="above">Above (>=)</option>
                                            <option value="below">Below (<=)</option>
                                        </select>
                                    </div>
                                    <button onclick="addAlert()">Add Alert</button>
                                    <button class="btn-secondary" onclick="checkAlerts()">Check Alerts</button>
                                </div>
                            </div>
                            <div>
                                <h4 style="color: var(--text-secondary); margin-bottom: 15px;">Active Alerts</h4>
                                <ul class="symbol-list" id="alerts-list" style="max-height: 400px;">
                                    <li class="empty-state">No alerts set. Add one to get started.</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div id="portfolio-tab" style="display: none;">
                        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px;">
                            <div>
                                <h4 style="color: var(--text-secondary); margin-bottom: 15px;">Add Position</h4>
                                <div class="fetch-form">
                                    <div class="input-group">
                                        <label for="position-symbol">Symbol</label>
                                        <input type="text" id="position-symbol" placeholder="AAPL" />
                                    </div>
                                    <div class="input-group">
                                        <label for="position-quantity">Quantity</label>
                                        <input type="number" id="position-quantity" placeholder="10" step="0.01" />
                                    </div>
                                    <div class="input-group">
                                        <label for="position-price">Buy/Sell Price</label>
                                        <input type="number" id="position-price" placeholder="150.00" step="0.01" />
                                    </div>
                                    <div class="input-group">
                                        <label for="position-type">Type</label>
                                        <select id="position-type">
                                            <option value="buy">Buy (Long)</option>
                                            <option value="sell">Sell (Short)</option>
                                        </select>
                                    </div>
                                    <div class="input-group">
                                        <label for="position-date">Date</label>
                                        <input type="date" id="position-date" />
                                    </div>
                                    <div class="input-group">
                                        <label for="position-notes">Notes (optional)</label>
                                        <input type="text" id="position-notes" placeholder="Optional notes" />
                                    </div>
                                    <button onclick="addPosition()">Add Position</button>
                                </div>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <h4 style="color: var(--text-secondary);">Portfolio</h4>
                                    <div id="portfolio-summary" style="text-align: right;">
                                        <span style="color: var(--text-secondary);">Total: </span>
                                        <span id="portfolio-total-value">$0.00</span>
                                        <span id="portfolio-total-pl" style="margin-left: 10px;">+$0.00 (0.00%)</span>
                                    </div>
                                </div>
                                <ul class="symbol-list" id="portfolio-list" style="max-height: 400px;">
                                    <li class="empty-state">No positions. Add your first trade to start tracking.</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div id="macro-tab" style="display: none;">
                        <ul class="symbol-list" id="macro-list">
                            <li class="empty-state">No macro data loaded.</li>
                        </ul>
                    </div>

                    <div id="log-tab" style="display: none;">
                        <div class="log-container" id="log-container">
                            <div class="log-entry log-info">[INIT] Financial Pipeline ready</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Tauri v2 API
        async function invoke(cmd, args = {}) {
            if (window.__TAURI__ && window.__TAURI__.core && window.__TAURI__.core.invoke) {
                console.log('Tauri invoke:', cmd, args);
                try {
                    const result = await window.__TAURI__.core.invoke(cmd, args);
                    console.log('Tauri result:', result);
                    return result;
                } catch (e) {
                    console.error('Tauri error:', e);
                    throw e;
                }
            } else {
                console.log('Mock invoke (Tauri not available):', cmd, args);
                return mockInvoke(cmd, args);
            }
        }

        // Mock invoke for testing in browser
        async function mockInvoke(cmd, args) {
            if (cmd === 'get_symbols') {
                return [
                    { symbol: 'AAPL', price: 261.05 },
                    { symbol: 'MSFT', price: 470.67 }
                ];
            }
            if (cmd === 'fetch_prices') {
                return { success: true, message: 'Fetched ' + args.symbols };
            }
            return null;
        }

        function log(message, type = 'info') {
            const container = document.getElementById('log-container');
            const entry = document.createElement('div');
            entry.className = 'log-entry log-' + type;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }

        async function refreshList() {
            try {
                log('Refreshing symbol list...', 'info');
                const symbols = await invoke('get_symbols');
                const list = document.getElementById('symbol-list');

                if (symbols && symbols.length > 0) {
                    // Sort symbols based on selected option
                    const sortOption = document.getElementById('sort-select').value;
                    symbols.sort((a, b) => {
                        switch (sortOption) {
                            case 'change-desc':
                                return b.change_percent - a.change_percent;
                            case 'change-asc':
                                return a.change_percent - b.change_percent;
                            case 'price-desc':
                                return b.price - a.price;
                            case 'price-asc':
                                return a.price - b.price;
                            case 'symbol-asc':
                                return a.symbol.localeCompare(b.symbol);
                            case 'symbol-desc':
                                return b.symbol.localeCompare(a.symbol);
                            default:
                                return b.change_percent - a.change_percent;
                        }
                    });

                    list.innerHTML = symbols.map(s => {
                        const changeColor = s.change_direction === 'up' ? 'var(--success)' :
                                           s.change_direction === 'down' ? 'var(--error)' : 'var(--text-secondary)';
                        const changeSign = s.change_percent >= 0 ? '+' : '';
                        const arrow = s.change_direction === 'up' ? '▲' :
                                     s.change_direction === 'down' ? '▼' : '';
                        return `
                        <li class="symbol-item" onclick="toggleSymbolMenu('${s.symbol}')">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span class="symbol-ticker">${s.symbol}</span>
                                <div style="text-align: right;">
                                    <span class="symbol-price" style="color: ${changeColor};">$${s.price.toFixed(2)}</span>
                                    <span style="color: ${changeColor}; font-size: 0.85rem; margin-left: 8px;">
                                        ${arrow} ${changeSign}${s.change_percent.toFixed(2)}%
                                    </span>
                                </div>
                            </div>
                            <div id="menu-${s.symbol}" class="symbol-menu" style="display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border);">
                                <button onclick="event.stopPropagation(); viewIndicators('${s.symbol}')" style="margin-right: 5px;">View Indicators</button>
                                <button onclick="event.stopPropagation(); exportSymbol('${s.symbol}')" class="btn-secondary">Export CSV</button>
                            </div>
                        </li>
                    `}).join('');
                    document.getElementById('symbol-count').textContent = symbols.length;
                    log(`Loaded ${symbols.length} symbols`, 'success');
                } else {
                    list.innerHTML = '<li class="empty-state">No data loaded. Fetch some symbols to get started.</li>';
                }
            } catch (e) {
                log('Error refreshing: ' + e, 'error');
            }
        }

        function toggleSymbolMenu(symbol) {
            const menu = document.getElementById('menu-' + symbol);
            if (menu) {
                menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
            }
        }

        function viewIndicators(symbol) {
            document.getElementById('indicator-symbol').value = symbol;
            switchTab('indicators');
            calculateIndicators();
        }

        async function exportSymbol(symbol) {
            try {
                log(`Exporting ${symbol} to CSV...`, 'info');
                const result = await invoke('export_csv', { symbol });
                log(result.message, result.success ? 'success' : 'error');
                alert(result.message);
            } catch (e) {
                log('Export error: ' + e, 'error');
                alert('Error: ' + e);
            }
        }

        async function searchCompany(query) {
            const resultsDiv = document.getElementById('search-results');
            if (query.length < 2) {
                resultsDiv.innerHTML = '';
                return;
            }

            try {
                const symbols = await invoke('search_symbol', { query });
                if (symbols && symbols.length > 0) {
                    resultsDiv.innerHTML = symbols.map(s => `
                        <button onclick="fetchAndSelect('${s}')" style="margin: 2px;">${s}</button>
                    `).join('');
                } else {
                    resultsDiv.innerHTML = '<span style="color: var(--text-secondary);">No matches</span>';
                }
            } catch (e) {
                resultsDiv.innerHTML = '';
            }
        }

        async function fetchAndSelect(symbol) {
            document.getElementById('search-input').value = '';
            document.getElementById('search-results').innerHTML = '';
            await fetchPrices(symbol, '1y');
        }

        async function fetchPrices(symbols, period) {
            const statusEl = document.querySelector('.stat-value');
            const origText = statusEl.textContent;
            statusEl.textContent = '...';
            statusEl.style.color = '#f59e0b';

            try {
                log(`Fetching ${symbols} (${period})...`, 'info');
                const result = await invoke('fetch_prices', { symbols, period });
                log(result.message, result.success ? 'success' : 'error');
                alert(result.message);
                await refreshList();
            } catch (e) {
                log('Error fetching: ' + e, 'error');
                alert('Error: ' + e);
            } finally {
                statusEl.style.color = '#38bdf8';
            }
        }

        async function fetchQuick(symbols) {
            const period = document.getElementById('period').value;
            await fetchPrices(symbols, period);
        }

        async function fetchFred(indicators) {
            try {
                log(`Fetching FRED indicators: ${indicators}...`, 'info');
                const result = await invoke('fetch_fred', { indicators });
                log(result.message, result.success ? 'success' : 'error');
                alert(result.message);
            } catch (e) {
                log('Error fetching FRED: ' + e, 'error');
                alert('Error: ' + e);
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');

            document.getElementById('stocks-tab').style.display = tab === 'stocks' ? 'block' : 'none';
            document.getElementById('indicators-tab').style.display = tab === 'indicators' ? 'block' : 'none';
            document.getElementById('alerts-tab').style.display = tab === 'alerts' ? 'block' : 'none';
            document.getElementById('portfolio-tab').style.display = tab === 'portfolio' ? 'block' : 'none';
            document.getElementById('macro-tab').style.display = tab === 'macro' ? 'block' : 'none';
            document.getElementById('log-tab').style.display = tab === 'log' ? 'block' : 'none';

            if (tab === 'alerts') {
                loadAlerts();
            }
            if (tab === 'portfolio') {
                loadPortfolio();
            }
        }

        async function calculateIndicators() {
            const symbol = document.getElementById('indicator-symbol').value.trim();
            if (!symbol) {
                alert('Please enter a symbol');
                return;
            }

            try {
                log(`Calculating indicators for ${symbol}...`, 'info');
                const result = await invoke('calculate_indicators', { symbol });
                log(result.message, result.success ? 'success' : 'error');
                alert(result.message);
                if (result.success) {
                    await loadIndicators();
                }
            } catch (e) {
                log('Error calculating: ' + e, 'error');
                alert('Error: ' + e);
            }
        }

        async function fetchTrends() {
            const symbol = document.getElementById('indicator-symbol').value.trim();
            if (!symbol) {
                alert('Please enter a symbol');
                return;
            }

            try {
                log(`Fetching Google Trends for ${symbol}...`, 'info');
                const result = await invoke('fetch_trends', { keyword: symbol });
                log(result.message, result.success ? 'success' : 'error');
                alert(result.message);

                // If successful and Google Trends is selected, show the chart
                if (result.success) {
                    const indicatorSelect = document.getElementById('indicator-select');
                    indicatorSelect.value = 'GOOGLE_TRENDS';
                    await chartIndicator('GOOGLE_TRENDS');
                }
            } catch (e) {
                log('Error fetching trends: ' + e, 'error');
                alert('Error: ' + e);
            }
        }

        async function loadIndicators() {
            const symbol = document.getElementById('indicator-symbol').value.trim();
            if (!symbol) {
                alert('Please enter a symbol');
                return;
            }

            try {
                log(`Loading indicators for ${symbol}...`, 'info');
                const indicators = await invoke('get_indicators', { symbol });
                const list = document.getElementById('indicator-list');

                if (indicators && indicators.length > 0) {
                    list.innerHTML = indicators.map(ind => `
                        <li class="symbol-item" onclick="chartIndicator('${ind.name}')">
                            <span class="symbol-ticker">${ind.name}</span>
                            <span class="symbol-price">${ind.value.toFixed(2)}</span>
                        </li>
                    `).join('');
                    log(`Loaded ${indicators.length} indicators for ${symbol}`, 'success');
                } else {
                    list.innerHTML = '<li class="empty-state">No indicators calculated. Click Calculate first.</li>';
                }
            } catch (e) {
                log('Error loading indicators: ' + e, 'error');
                alert('Error: ' + e);
            }
        }

        // Chart instance
        let indicatorChart = null;

        async function showChart() {
            const symbol = document.getElementById('indicator-symbol').value.trim();
            const indicatorName = document.getElementById('indicator-select').value;

            if (!symbol) {
                alert('Please enter a symbol');
                return;
            }

            if (!indicatorName) {
                alert('Please select an indicator');
                return;
            }

            await chartIndicator(indicatorName);
        }

        async function chartIndicator(indicatorName) {
            const symbol = document.getElementById('indicator-symbol').value.trim();
            if (!symbol) {
                alert('Please enter a symbol');
                return;
            }

            try {
                log(`Loading chart data for ${symbol} ${indicatorName}...`, 'info');

                // Destroy existing chart
                if (indicatorChart) {
                    indicatorChart.destroy();
                }

                const ctx = document.getElementById('indicator-chart').getContext('2d');

                if (indicatorName === 'CANDLESTICK') {
                    // Candlestick chart
                    const prices = await invoke('get_price_history', { symbol });
                    if (prices.length === 0) {
                        alert('No price data available. Fetch prices first.');
                        return;
                    }

                    const candleData = prices.map(p => ({
                        x: new Date(p.date).getTime(),
                        o: p.open,
                        h: p.high,
                        l: p.low,
                        c: p.close
                    }));

                    indicatorChart = new Chart(ctx, {
                        type: 'candlestick',
                        data: {
                            datasets: [{
                                label: `${symbol} OHLC`,
                                data: candleData,
                                color: {
                                    up: '#22c55e',
                                    down: '#ef4444',
                                    unchanged: '#94a3b8'
                                },
                                borderColor: {
                                    up: '#22c55e',
                                    down: '#ef4444',
                                    unchanged: '#94a3b8'
                                }
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    labels: { color: '#f1f5f9' }
                                }
                            },
                            scales: {
                                x: {
                                    type: 'time',
                                    time: {
                                        unit: 'day',
                                        displayFormats: { day: 'MMM d' }
                                    },
                                    ticks: { color: '#94a3b8', maxTicksLimit: 10 },
                                    grid: { color: '#334155' }
                                },
                                y: {
                                    ticks: { color: '#94a3b8' },
                                    grid: { color: '#334155' }
                                }
                            }
                        }
                    });

                    log(`Candlestick chart loaded for ${symbol}`, 'success');
                } else if (indicatorName === 'GOOGLE_TRENDS') {
                    // Google Trends chart
                    const trends = await invoke('get_trends', { keyword: symbol });
                    if (trends.length === 0) {
                        alert('No trends data. Click "Fetch Trends" first.');
                        return;
                    }

                    indicatorChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: trends.map(t => t.date),
                            datasets: [{
                                label: `${symbol} Google Trends (Interest)`,
                                data: trends.map(t => t.value),
                                borderColor: '#4285f4', // Google blue
                                backgroundColor: '#4285f420',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.3,
                                pointRadius: 0,
                                pointHoverRadius: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    labels: { color: '#f1f5f9' }
                                }
                            },
                            scales: {
                                x: {
                                    ticks: { color: '#94a3b8', maxTicksLimit: 10 },
                                    grid: { color: '#334155' }
                                },
                                y: {
                                    min: 0,
                                    max: 100,
                                    ticks: { color: '#94a3b8' },
                                    grid: { color: '#334155' },
                                    title: {
                                        display: true,
                                        text: 'Search Interest (0-100)',
                                        color: '#94a3b8'
                                    }
                                }
                            },
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            }
                        }
                    });

                    log(`Google Trends chart loaded for ${symbol}`, 'success');
                } else {
                    // Line chart for price or indicators
                    let data, labels, label, borderColor;

                    if (indicatorName === 'PRICE') {
                        const prices = await invoke('get_price_history', { symbol });
                        labels = prices.map(p => p.date);
                        data = prices.map(p => p.close);
                        label = `${symbol} Close Price`;
                        borderColor = '#38bdf8';
                    } else {
                        const history = await invoke('get_indicator_history', { symbol, indicatorName });
                        labels = history.map(h => h.date);
                        data = history.map(h => h.value);
                        label = `${symbol} ${indicatorName}`;

                        if (indicatorName.startsWith('RSI')) {
                            borderColor = '#f59e0b';
                        } else if (indicatorName.startsWith('SMA')) {
                            borderColor = '#22c55e';
                        } else if (indicatorName.startsWith('EMA')) {
                            borderColor = '#8b5cf6';
                        } else if (indicatorName.startsWith('MACD')) {
                            borderColor = '#ef4444';
                        } else if (indicatorName.startsWith('BB_')) {
                            borderColor = '#ec4899'; // Pink for Bollinger Bands
                        } else if (indicatorName.startsWith('ATR')) {
                            borderColor = '#14b8a6'; // Teal for ATR
                        } else if (indicatorName.startsWith('STOCH')) {
                            borderColor = '#06b6d4'; // Cyan for Stochastic
                        } else if (indicatorName === 'OBV') {
                            borderColor = '#a855f7'; // Purple for OBV
                        } else if (indicatorName.startsWith('ADX') || indicatorName.includes('DI_')) {
                            borderColor = '#f97316'; // Orange for ADX/DI
                        } else {
                            borderColor = '#38bdf8';
                        }
                    }

                    if (data.length === 0) {
                        alert('No data available. Calculate indicators first.');
                        return;
                    }

                    indicatorChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: label,
                                data: data,
                                borderColor: borderColor,
                                backgroundColor: borderColor + '20',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.1,
                                pointRadius: 0,
                                pointHoverRadius: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    labels: { color: '#f1f5f9' }
                                }
                            },
                            scales: {
                                x: {
                                    ticks: { color: '#94a3b8', maxTicksLimit: 10 },
                                    grid: { color: '#334155' }
                                },
                                y: {
                                    ticks: { color: '#94a3b8' },
                                    grid: { color: '#334155' }
                                }
                            },
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            }
                        }
                    });

                    log(`Chart loaded for ${label}`, 'success');
                }
            } catch (e) {
                log('Error loading chart: ' + e, 'error');
                alert('Error: ' + e);
            }
        }

        function showDetails(symbol) {
            log(`Selected ${symbol}`, 'info');
            // TODO: Show price chart
        }

        // Alerts management
        async function addAlert() {
            const symbol = document.getElementById('alert-symbol').value.trim();
            const price = parseFloat(document.getElementById('alert-price').value);
            const condition = document.getElementById('alert-condition').value;

            if (!symbol) {
                alert('Please enter a symbol');
                return;
            }

            if (isNaN(price) || price <= 0) {
                alert('Please enter a valid price');
                return;
            }

            try {
                log(`Adding alert: ${symbol} ${condition} $${price.toFixed(2)}...`, 'info');
                const result = await invoke('add_alert', {
                    symbol,
                    targetPrice: price,
                    condition
                });
                log(result.message, result.success ? 'success' : 'error');
                alert(result.message);

                // Clear form and reload
                document.getElementById('alert-symbol').value = '';
                document.getElementById('alert-price').value = '';
                await loadAlerts();
            } catch (e) {
                log('Error adding alert: ' + e, 'error');
                alert('Error: ' + e);
            }
        }

        async function loadAlerts() {
            try {
                const alerts = await invoke('get_alerts', { onlyActive: false });
                const list = document.getElementById('alerts-list');

                if (alerts && alerts.length > 0) {
                    list.innerHTML = alerts.map(a => `
                        <li class="symbol-item" style="flex-direction: column; align-items: stretch;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <span class="symbol-ticker">${a.symbol}</span>
                                    <span style="color: var(--text-secondary); margin-left: 10px;">
                                        ${a.condition === 'above' ? '>=' : '<='} $${a.target_price.toFixed(2)}
                                    </span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span style="color: ${a.triggered ? 'var(--success)' : 'var(--text-secondary)'};">
                                        ${a.triggered ? 'TRIGGERED' : 'Active'}
                                    </span>
                                    <button onclick="event.stopPropagation(); deleteAlert(${a.id})" class="btn-secondary" style="padding: 5px 10px; font-size: 0.8rem;">
                                        Delete
                                    </button>
                                </div>
                            </div>
                        </li>
                    `).join('');
                    log(`Loaded ${alerts.length} alerts`, 'success');
                } else {
                    list.innerHTML = '<li class="empty-state">No alerts set. Add one to get started.</li>';
                }
            } catch (e) {
                log('Error loading alerts: ' + e, 'error');
            }
        }

        async function deleteAlert(alertId) {
            try {
                log(`Deleting alert ${alertId}...`, 'info');
                const result = await invoke('delete_alert', { alertId });
                log(result.message, result.success ? 'success' : 'error');
                await loadAlerts();
            } catch (e) {
                log('Error deleting alert: ' + e, 'error');
                alert('Error: ' + e);
            }
        }

        async function checkAlerts() {
            try {
                log('Checking alerts against current prices...', 'info');
                const triggered = await invoke('check_alerts');

                if (triggered && triggered.length > 0) {
                    const messages = triggered.map(a =>
                        `${a.symbol} ${a.condition === 'above' ? 'reached' : 'dropped to'} $${a.target_price.toFixed(2)}`
                    ).join('\n');
                    alert(`Alerts triggered!\n\n${messages}`);
                    log(`${triggered.length} alerts triggered!`, 'success');
                } else {
                    log('No alerts triggered', 'info');
                    alert('No alerts triggered. Current prices have not met any alert conditions.');
                }

                await loadAlerts();
            } catch (e) {
                log('Error checking alerts: ' + e, 'error');
                alert('Error: ' + e);
            }
        }

        // Portfolio management
        async function addPosition() {
            const symbol = document.getElementById('position-symbol').value.trim();
            const quantity = parseFloat(document.getElementById('position-quantity').value);
            const price = parseFloat(document.getElementById('position-price').value);
            const positionType = document.getElementById('position-type').value;
            const date = document.getElementById('position-date').value;
            const notes = document.getElementById('position-notes').value.trim() || null;

            if (!symbol) {
                alert('Please enter a symbol');
                return;
            }

            if (isNaN(quantity) || quantity <= 0) {
                alert('Please enter a valid quantity');
                return;
            }

            if (isNaN(price) || price <= 0) {
                alert('Please enter a valid price');
                return;
            }

            if (!date) {
                alert('Please select a date');
                return;
            }

            try {
                log(`Adding ${positionType} position: ${quantity} x ${symbol} @ $${price.toFixed(2)}...`, 'info');
                const result = await invoke('add_position', {
                    symbol,
                    quantity,
                    price,
                    positionType,
                    date,
                    notes
                });
                log(result.message, result.success ? 'success' : 'error');
                alert(result.message);

                // Clear form and reload
                document.getElementById('position-symbol').value = '';
                document.getElementById('position-quantity').value = '';
                document.getElementById('position-price').value = '';
                document.getElementById('position-notes').value = '';
                await loadPortfolio();
            } catch (e) {
                log('Error adding position: ' + e, 'error');
                alert('Error: ' + e);
            }
        }

        async function loadPortfolio() {
            try {
                const portfolio = await invoke('get_portfolio');
                const list = document.getElementById('portfolio-list');

                // Update summary
                const totalValueEl = document.getElementById('portfolio-total-value');
                const totalPlEl = document.getElementById('portfolio-total-pl');

                totalValueEl.textContent = `$${portfolio.total_value.toFixed(2)}`;

                const plColor = portfolio.total_profit_loss >= 0 ? 'var(--success)' : 'var(--error)';
                const plSign = portfolio.total_profit_loss >= 0 ? '+' : '';
                totalPlEl.style.color = plColor;
                totalPlEl.textContent = `${plSign}$${portfolio.total_profit_loss.toFixed(2)} (${plSign}${portfolio.total_profit_loss_percent.toFixed(2)}%)`;

                if (portfolio.positions && portfolio.positions.length > 0) {
                    list.innerHTML = portfolio.positions.map(p => {
                        const plColor = p.profit_loss >= 0 ? 'var(--success)' : 'var(--error)';
                        const plSign = p.profit_loss >= 0 ? '+' : '';
                        const arrow = p.profit_loss > 0 ? '▲' : p.profit_loss < 0 ? '▼' : '';
                        const typeLabel = p.position_type === 'buy' ? 'LONG' : 'SHORT';
                        const typeBg = p.position_type === 'buy' ? 'var(--success)' : 'var(--error)';

                        return `
                        <li class="symbol-item" style="flex-direction: column; align-items: stretch;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <span class="symbol-ticker">${p.symbol}</span>
                                    <span style="background: ${typeBg}; color: var(--bg-primary); padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; margin-left: 8px;">${typeLabel}</span>
                                    <span style="color: var(--text-secondary); margin-left: 10px; font-size: 0.85rem;">
                                        ${p.quantity} shares @ $${p.price.toFixed(2)}
                                    </span>
                                </div>
                                <div style="text-align: right;">
                                    <span style="color: var(--text-primary);">$${p.current_value.toFixed(2)}</span>
                                    <span style="color: ${plColor}; margin-left: 10px;">
                                        ${arrow} ${plSign}$${p.profit_loss.toFixed(2)} (${plSign}${p.profit_loss_percent.toFixed(2)}%)
                                    </span>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px; font-size: 0.8rem; color: var(--text-secondary);">
                                <span>Bought: ${p.date} | Current: $${p.current_price.toFixed(2)}</span>
                                <button onclick="event.stopPropagation(); deletePosition(${p.id})" class="btn-secondary" style="padding: 4px 8px; font-size: 0.75rem;">
                                    Remove
                                </button>
                            </div>
                        </li>
                    `}).join('');
                    log(`Loaded ${portfolio.positions.length} positions`, 'success');
                } else {
                    list.innerHTML = '<li class="empty-state">No positions. Add your first trade to start tracking.</li>';
                }
            } catch (e) {
                log('Error loading portfolio: ' + e, 'error');
            }
        }

        async function deletePosition(positionId) {
            if (!confirm('Remove this position?')) return;

            try {
                log(`Removing position ${positionId}...`, 'info');
                const result = await invoke('delete_position', { positionId });
                log(result.message, result.success ? 'success' : 'error');
                await loadPortfolio();
            } catch (e) {
                log('Error removing position: ' + e, 'error');
                alert('Error: ' + e);
            }
        }

        // Auto-refresh functionality
        let autoRefreshTimer = null;

        function updateLastRefreshTime() {
            const now = new Date();
            document.getElementById('last-refresh').textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function toggleAutoRefresh() {
            const toggle = document.getElementById('auto-refresh-toggle');
            const statusEl = document.getElementById('refresh-status');

            if (toggle.checked) {
                startAutoRefresh();
                statusEl.textContent = 'Auto-refresh on';
                statusEl.classList.add('active');
            } else {
                stopAutoRefresh();
                statusEl.textContent = 'Auto-refresh off';
                statusEl.classList.remove('active');
            }
        }

        function updateRefreshInterval() {
            const toggle = document.getElementById('auto-refresh-toggle');
            if (toggle.checked) {
                stopAutoRefresh();
                startAutoRefresh();
            }
        }

        function startAutoRefresh() {
            const interval = parseInt(document.getElementById('refresh-interval').value);
            log(`Auto-refresh started (every ${interval / 60000} min)`, 'info');

            // Do initial refresh
            autoRefreshPrices();

            // Set up interval
            autoRefreshTimer = setInterval(autoRefreshPrices, interval);
        }

        function stopAutoRefresh() {
            if (autoRefreshTimer) {
                clearInterval(autoRefreshTimer);
                autoRefreshTimer = null;
                log('Auto-refresh stopped', 'info');
            }
        }

        async function autoRefreshPrices() {
            try {
                // Get all tracked symbols
                const symbols = await invoke('get_symbols');
                if (!symbols || symbols.length === 0) {
                    log('No symbols to refresh', 'info');
                    updateLastRefreshTime();
                    return;
                }

                // Fetch latest prices for all symbols
                const symbolList = symbols.map(s => s.symbol).join(',');
                log(`Auto-refreshing ${symbols.length} symbols...`, 'info');

                const result = await invoke('fetch_prices', { symbols: symbolList, period: '1d' });

                if (result.success) {
                    log(`Auto-refresh: ${result.message}`, 'success');
                } else {
                    log(`Auto-refresh warning: ${result.message}`, 'error');
                }

                // Update the list
                await refreshList();
                updateLastRefreshTime();

                // Check alerts silently (no popup unless triggered)
                const triggered = await invoke('check_alerts');
                if (triggered && triggered.length > 0) {
                    const messages = triggered.map(a =>
                        `${a.symbol} ${a.condition === 'above' ? 'reached' : 'dropped to'} $${a.target_price.toFixed(2)}`
                    ).join('\n');
                    alert(`Alerts triggered!\n\n${messages}`);
                    log(`${triggered.length} alerts triggered!`, 'success');
                    await loadAlerts();
                }

            } catch (e) {
                log('Auto-refresh error: ' + e, 'error');
            }
        }

        // Form submission
        document.getElementById('fetch-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const symbols = document.getElementById('symbols').value;
            const period = document.getElementById('period').value;
            if (symbols) {
                await fetchPrices(symbols, period);
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            log('Financial Pipeline UI loaded', 'success');
            refreshList();
            updateLastRefreshTime();
            // Set default date to today for position form
            document.getElementById('position-date').valueAsDate = new Date();
        });
    </script>
</body>
</html>
